# Tutorial

##  PV_RCNN

### Data preparation

#### Import data

Import training and testing data from kitti dataset.
1. clean data in openpcdet:

  > data in Openpcdet is stored in : `/data/kitti`, firstly we should clean them

  `off_the_shelf/object_detection/pvrcnn/scripts/cleanData.sh`: remove all files in the folder

2. import data
   1. object data

      > it is simple because openpcdet is designed for object detection. You only need to import data into corresponding file folder directly.

      `off_the_shelf/object_detection/pvrcnn/scripts/importData.sh`: copy data from where you store data to openpcdet's folder.
   2. tracking data

      > It will be troublesome but I have finished the code which you can use directly.

      `util/format_utils/track2object.py`: transform data in object format to tracking format

      ```python
      if __name__ == '__main__':
          n = 10 # import data from No.0 scene to No.n scene, [0,n) 
      ```

#### Generate data info

> openpcdet needs it to test and train

1. Set config

   > `data/kitti/ImageSets`: there are `train.txt`, `test.txt`, `val.txt`
   >
   > each txt above contains which data will be used to train/test/validate.

   `off_the_shelf/object_detection/pvrcnn/scripts/createImageSets.py`: generate txts above.

   ```python
   openpcdet = "/home2/lie/InnovativePractice2/OpenPCDet"
   imagesets = "data/kitti/ImageSets"
   testing = "data/kitti/testing"
   training = "data/kitti/training"
   reference = "velodyne"
   referencesuffix = ".bin"
   valratio = 0.3 # last 30% training data is used as validation data
   ```

   

2. generate

   > code following is an official code proposed by author of openpcdet  

   `python -m pcdet.datasets.kitti.kitti_dataset create_kitti_infos tools/cfgs/dataset_configs/kitti_dataset.yaml`



### Test 

`off_the_shelf/object_detection/pvrcnn/scripts/test.sh`:

```sh
path=.
CONFIG_FILE=${path}/cfgs/kitti_models/${pvrcnn_cfg} // config_file
BATCH_SIZE=4
CKPT=../models/${pvrcnn_ckpt} // checkpoint you use
python test.py --cfg_file ${CONFIG_FILE} --batch_size ${BATCH_SIZE} --ckpt ${CKPT}  --save_to_file
```

> the .sh need to put into `tools/visual_utils` of openpcdet

After test, the result will be saved in `output/cfgs/kitti_models/pv_rcnn/default/eval/epoch_*`

`output/cfgs/kitti_models/pv_rcnn/default/eval/epoch_*/val/default/final_result/data` will store labels generated by test.

#### Tracking data

> If you want to transform the label generated by test into tracking format, you need to run an extra code

`util/format_utils/object2AB3dMOT.py`

```python
object_result = "/home2/lie/InnovativePractice2/OpenPCDet/output/cfgs/kitti_models/pv_rcnn/default/eval/epoch_8369/val/default/final_result/data" # you need to change the path to yours
splitpos = "/home2/lie/InnovativePractice2/OpenPCDet/data/kitti/training/splitpos.txt"
output = "/home2/lie/InnovativePractice2/OpenPCDet/data/kitti/training/tracking_label" # output directory
```



