# Tutorial

## Usage

首先需要使用目标检测获得检测框，然后目标跟踪得到轨迹，最后采用我们的模型对结果进行进一步refine。
目标检测和目标跟踪算法的相应脚本与代码在off_the_shelf文件夹中。

### Object Detection

#### PVRCNN

数据集为kitti

> 注意：
>
> 1. ImageSets中的txt用来表示测试集、验证集和训练集分别使用哪些序号的数据
> 2. yaml配置文件需要修改，其 ROAD_PLANE 默认是ture.
> 3. object label中的dontcare应该总是在最后
> 4. label、image、velodyne、calib应该对应所有imagesets里的序号
> 5. 如果label里面什么也没有，生成预数据的时候会报错
> 6. tracking的某些帧可能没有label，转入openpcdet的时候要注意

`train.sh`: used to train pvrcnn model



## Work flow of the project

#### Object Detection

1. Transfer format of kitti tracking data into format of object data.


    1. 用format conversion里的track2object将tracking data导入openpcdet的data中
    2. 用off_the_shelf的createImageSets生成预数据
    3. 用openpcdet的test.py（或者off_the_shelf的test.sh）进行验证集测试

2. Generate bbox 

> tracking点云的0001文件夹176后面缺了几帧

#### automatic workflow

1. data preparation
   1. transport (need transport code from dataset to models)
   2. generate data info for pvrcnn ( need preprocess code for every model)
2. off_the_shelf result
   1. pvrcnn detection ( entry for testing for every detection model)
   2. transport to ab3dmot tracking 
      1. intermediate process between detection and tracking data (include abandoning low confidence)
   3. AB3DMOT get result (entry for testing for tracking model)
3. our net
   1. data preperation (from model format to our net dataset)
   2. predict proposed box
   3. generate our dataset 
   4. use net to adjust box (entry to test)
   5. check overlap, consolidate trajectory
   6. loop
4. post preprocess

## Details
###  PV_RCNN

#### Data preparation

##### Import data

Import training and testing data from kitti dataset.
1. clean data in openpcdet:

  > data in Openpcdet is stored in : `/data/kitti`, firstly we should clean them

  `off_the_shelf/object_detection/pvrcnn/scripts/cleanData.sh`: remove all files in the folder

2. import data
   1. object data

      > it is simple because openpcdet is designed for object detection. You only need to import data into corresponding file folder directly.

      `off_the_shelf/object_detection/pvrcnn/scripts/importData.sh`: copy data from where you store data to openpcdet's folder.
   2. tracking data

      > It will be troublesome but I have finished the code which you can use directly.

      `util/format_utils/track2object.py`: transform data in object format to tracking format

      ```python
      if __name__ == '__main__':
          n = 10 # import data from No.0 scene to No.n scene, [0,n) 
      ```

##### Generate data info

> openpcdet needs it to test and train

1. Set config

   > `data/kitti/ImageSets`: there are `train.txt`, `test.txt`, `val.txt`
   >
   > each txt above contains which data will be used to train/test/validate.

   `off_the_shelf/object_detection/pvrcnn/scripts/createImageSets.py`: generate txts above.

   ```python
   openpcdet = "/home2/lie/InnovativePractice2/OpenPCDet"
   imagesets = "data/kitti/ImageSets"
   testing = "data/kitti/testing"
   training = "data/kitti/training"
   reference = "velodyne"
   referencesuffix = ".bin"
   valratio = 0.3 # last 30% training data is used as validation data
   ```

   

2. generate

   > code following is an official code proposed by author of openpcdet  

   `python -m pcdet.datasets.kitti.kitti_dataset create_kitti_infos tools/cfgs/dataset_configs/kitti_dataset.yaml`



#### Test 

`off_the_shelf/object_detection/pvrcnn/scripts/test.sh`:

```sh
path=.
CONFIG_FILE=${path}/cfgs/kitti_models/${pvrcnn_cfg} // config_file
BATCH_SIZE=4
CKPT=../models/${pvrcnn_ckpt} // checkpoint you use
python test.py --cfg_file ${CONFIG_FILE} --batch_size ${BATCH_SIZE} --ckpt ${CKPT}  --save_to_file
```

> the .sh need to put into `tools/visual_utils` of openpcdet

After test, the result will be saved in `output/cfgs/kitti_models/pv_rcnn/default/eval/epoch_*`

`output/cfgs/kitti_models/pv_rcnn/default/eval/epoch_*/val/default/final_result/data` will store labels generated by test.

##### Tracking data

> If you want to transform the label generated by test into tracking format, you need to run an extra code

`util/format_utils/object2AB3dMOT.py`

```python
object_result = "/home2/lie/InnovativePractice2/OpenPCDet/output/cfgs/kitti_models/pv_rcnn/default/eval/epoch_8369/val/default/final_result/data" # you need to change the path to yours
splitpos = "/home2/lie/InnovativePractice2/OpenPCDet/data/kitti/training/splitpos.txt"
output = "/home2/lie/InnovativePractice2/OpenPCDet/data/kitti/training/tracking_label" # output directory
```

